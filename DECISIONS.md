# Архитектурные решения и допущения

## Вопросы и принятые решения

### 1. OpenAPI спецификация
**Вопрос:** В задании упоминается, что OpenAPI спецификация будет предоставлена, но она отсутствовала.

**Решение:** Создал собственную спецификацию на основе требований задания, включив все необходимые эндпоинты и дополнительные для полноценной работы сервиса.

### 2. Алгоритм выбора рецензентов
**Вопрос:** Какой алгоритм использовать для выбора рецензентов из команды?

**Решение:** Реализовал случайный выбор с использованием `ORDER BY RANDOM()` в SQL для равномерного распределения нагрузки. В production можно заменить на более сложный алгоритм с учётом:
- Текущей загрузки рецензентов
- Экспертизы в определённых областях
- Истории предыдущих ревью

### 3. Обработка отсутствия рецензентов
**Вопрос:** Что делать, если в команде нет доступных рецензентов?

**Решение:** PR создаётся без рецензентов. Система не блокирует создание PR, но возвращает пустой список рецензентов. Это позволяет автору начать работу и назначить рецензентов позже вручную.

### 4. Идемпотентность операции merge
**Вопрос:** Как обеспечить идемпотентность merge?

**Решение:** При попытке merge уже смерженного PR операция успешно завершается, возвращая актуальное состояние. Используется условие `WHERE status IN ('OPEN', 'MERGED')` в SQL запросе.

### 5. Переназначение при массовой деактивации
**Вопрос:** Как обрабатывать случаи, когда при массовой деактивации невозможно найти замену?

**Решение:** 
- Система пытается найти замену для каждого деактивированного рецензента
- Если замена не найдена, PR остаётся с меньшим количеством рецензентов
- Возвращается статистика: сколько пользователей деактивировано и сколько PR переназначено

### 6. Аутентификация и авторизация
**Вопрос:** Нужна ли аутентификация?

**Решение:** Не реализована, предполагается, что сервис работает за API Gateway, который обеспечивает аутентификацию и авторизацию. В production можно добавить JWT или OAuth2.

### 7. Структура базы данных
**Вопрос:** Как организовать связь пользователей и команд?

**Решение:** One-to-many связь (пользователь может быть только в одной команде). Если требуется many-to-many, можно добавить промежуточную таблицу `team_members`.

### 8. Обработка ошибок
**Решение:** Реализована единообразная обработка ошибок с возвратом JSON:
```json
{
  "error": "описание ошибки"
}
```

### 9. Логирование
**Решение:** Базовое логирование с использованием стандартного `log` пакета. В production рекомендуется использовать структурированное логирование (zap, logrus).

### 10. Метрики и мониторинг
**Решение:** Не реализованы в рамках MVP. В production добавить:
- Prometheus метрики
- Distributed tracing (Jaeger/Zipkin)
- Health checks с детальной информацией о зависимостях

## Оптимизации производительности

### Реализованные:
1. **Индексы БД** на часто используемых полях (team_id, is_active, status)
2. **Пул соединений** с БД (max 25 connections)
3. **Prepared statements** для массовых операций
4. **Batch операции** при добавлении рецензентов

### Рекомендуемые для production:
1. **Кеширование** (Redis) для статистики и списков команд
2. **Read replicas** для операций чтения
3. **Message queue** для асинхронных операций переназначения
4. **Rate limiting** для защиты от перегрузки
5. **Connection pooling** на уровне PgBouncer

## Масштабирование

### Горизонтальное масштабирование:
- Сервис stateless, можно запускать несколько инстансов за балансировщиком
- БД может стать bottleneck - рекомендуется шардирование по team_id

### Вертикальное масштабирование:
- Увеличение ресурсов БД при росте данных
- Оптимизация запросов при необходимости

## Безопасность

### Реализовано:
- Prepared statements для защиты от SQL инъекций
- Валидация входных данных
- CORS headers

### Рекомендуется добавить:
- Rate limiting
- Request signing
- Audit logging
- Encryption at rest для sensitive данных
- Network policies в Kubernetes

## Тестирование

### Реализовано:
- Unit тесты для бизнес-логики
- Интеграционные тесты для API
- Нагрузочное тестирование

### Рекомендуется добавить:
- Contract testing
- Chaos engineering
- Security testing (OWASP)
- Performance regression tests в CI/CD
